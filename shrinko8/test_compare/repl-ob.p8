pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
--------------------------------------
-- Please see 'Commented Source Code' section in the BBS
-- for the original commented source code
-- (The below had the comments stripped due to cart size limits)
--------------------------------------
local e,n,l=_ENV,{},{}for e,t in pairs(_ENV)do n[e]=t if type(t)=="function"then l[e]=true end end local _ENV=n nc,nk=true function p(t,e)for n=1,#e do if sub(e,n,n)==t then return n end end end function b(e,n)return sub(e,n,n)end local n,t,o=split"a,b,f,n,r,t,v,\\,\",',\n,*,#,-,|,+,^",split"⁷,⁸,ᶜ,\n,\r,	,ᵇ,\\,\",',\n,¹,²,³,⁴,⁵,⁶",{}for e=1,#n do o[n[e]]=t[e]end function y(n)return n>="0"and n<="9"end function nl(n)return n>="A"and n<="Z"or n>="a"and n<="z"or n=="_"or n>="█"or y(n)end function en(l,n,i,r)local e=""while n<=#l do local t=b(l,n)if t==i then break end if t=="\\"then n+=1local e=b(l,n)t=o[e]if e=="x"then e=tonum("0x"..sub(l,n+1,n+2))if e then n+=2else r"bad hex escape"end t=chr(e)elseif y(e)then local o=n while y(e)and n<o+3do n+=1e=b(l,n)end n-=1e=tonum(sub(l,o,n))if not e or e>=256then r"bad decimal escape"end t=chr(e)elseif e=="z"then repeat n+=1e=b(l,n)until not p(e," \r	ᶜᵇ\n")if e==""then r()end t=""n-=1elseif e==""then r()t=""end if not t then r("bad escape: "..e)t=""end elseif t=="\n"then r"unterminated string"break end e..=t n+=1end if n>#l then r("unterminated string",true)end return e,n+1end function nn(e,n,t,l)if b(e,n)=="["then n+=1local l=n while b(e,n)=="="do n+=1end local l="]"..sub(e,l,n-1).."]"local r=#l if b(e,n)=="["then n+=1if b(e,n)=="\n"then n+=1end local o=n while n<=#e and sub(e,n,n+r-1)~=l do n+=1end if n>=#e then t()end return sub(e,o,n-1),n+r end end if l then t"invalid long brackets"end return nil,n end function n4(t,u)local n,a,r,c,s,h,f,o=1,1,{},{},{},{}local function i(n,e)if u then n9(n,o)end f=n and not e end while n<=#t do o=n local e,d,l=b(t,n)if p(e," \r	ᶜᵇ\n")then n+=1d=true if e=="\n"then a+=1end elseif e=="-"and b(t,n+1)=="-"then n+=2if b(t,n)=="["then l,n=nn(t,n,i)end if not l then while n<=#t and b(t,n)~="\n"do n+=1end end if u then d=true else add(r,true)end elseif y(e)or e=="."and y(b(t,n+1))then local f,d="0123456789",true if e=="0"and p(b(t,n+1),"xX")then f..="AaBbCcDdEeFf"n+=2elseif e=="0"and p(b(t,n+1),"bB")then f="01"n+=2end while true do e=b(t,n)if e=="."and d then d=false elseif not p(e,f)then break end n+=1end l=sub(t,o,n-1)if not tonum(l)then i"bad number"l="0"end add(r,tonum(l))elseif nl(e)then while nl(b(t,n))do n+=1end add(r,sub(t,o,n-1))elseif e=="'"or e=='"'then l,n=en(t,n+1,e,i)add(r,{t=l})elseif e=="["and p(b(t,n+1),"=[")then l,n=nn(t,n,i,true)add(r,{t=l})else n+=1local l,f,d=unpack(split(sub(t,n,n+2),""))if l==e and f==e and p(e,".>")then n+=2if d=="="and p(e,">")then n+=1end elseif l==e and f~=e and p(e,"<>")and p(f,"<>")then n+=2if d=="="then n+=1end elseif l==e and p(e,".:^<>")then n+=1if f=="="and p(e,".^<>")then n+=1end elseif l=="="and p(e,"+-*/\\%^&|<>=~!")then n+=1elseif p(e,"+-*/\\%^&|<>=~#(){}[];,?@$.:")then else i("bad char: "..e)end add(r,sub(t,o,n-1))end if not d then add(c,a)add(s,o)add(h,n-1)end if f then r[#r],f=false,false end end return r,c,s,h end function nf(t,n)for e=1,#n do if n[e]==t then return e end end end function nu(n)return unpack(n,1,n.n)end function ee(e)local n={}for e,t in next,e do n[e]=t end return n end local n=split"and,break,do,else,elseif,end,false,for,function,goto,if,in,local,nil,not,or,repeat,return,then,true,until,while"ns={}for n in all(n)do ns[n]=true end local function nn(n)return type(n)=="string"and b(n,#n)=="="end nv=split"end,else,elseif,until"function ny(n,ne)local r,q,t=n4(n,true)local n,i,u,x,f,s,h,e,c,m,a,v=1,0,0,{}local function o(e)n9(e,t[n-1]or 1)end local function p(n)return function()return n end end local function _(e)local n=f[e]if n then return function(t)return t[n][e]end else n=f._ENV return function(t)return t[n]._ENV[e]end end end local function nt()local n=f["..."]if not n or n~=v then o"unexpected '...'"end return function(e)return nu(e[n]["..."])end end local function z(e)local n=f[e]if n then return function(t)return t[n],e end else n=f._ENV return function(t)return t[n]._ENV,e end end end local function t(e)local t=r[n]n+=1if t==e then return end if t==nil then o()end o("expected: "..e)end local function d(e)if not e then e=r[n]n+=1end if e==nil then o()end if type(e)=="string"and nl(b(e,1))and not ns[e]then return e end if type(e)=="string"then o("invalid identifier: "..e)end o"identifier expected"end local function l(e)if r[n]==e then n+=1return true end end local function g()f=setmetatable({},{__index=f})i+=1end local function k()f=getmetatable(f).__index i-=1end local function b(l,t)local e,n={},#t for n=1,n-1do e[n]=t[n](l)end if n>0then local t=pack(t[n](l))if t.n~=1then for l=1,t.n do e[n+l-1]=t[l]end n+=t.n-1else e[n]=t[1]end end e.n=n return e end local function w(e)local n={}add(n,(e()))while l","do add(n,(e()))end return n end local function y(r,o,i)local n={}if i then add(n,i)elseif not l")"then while true do add(n,(e()))if l")"then break end t","end end if o then return function(e)local t=r(e)return t[o](t,nu(b(e,n)))end,true,nil,function(e)local t=r(e)return t[o],pack(t,nu(b(e,n)))end else return function(e)return r(e)(nu(b(e,n)))end,true,nil,function(e)return r(e),b(e,n)end end end local function nl()local o,u,c,a={},{},1while not l"}"do a=nil local i,f if l"["then i=e()t"]"t"="f=e()elseif r[n+1]=="="then i=p(d())t"="f=e()else i=p(c)f=e()c+=1a=#o+1end add(o,i)add(u,f)if l"}"then break end if not l";"then t","end end return function(e)local t={}for n=1,#o do if n==a then local l,n=o[n](e),pack(u[n](e))for e=1,n.n do t[l+e-1]=n[e]end else t[o[n](e)]=u[n](e)end end return t end end local function j(s,h)local n,b,e if s then if h then g()n=d()f[n]=i e=z(n)else n={d()}while l"."do add(n,d())end if l":"then add(n,d())b=true end if#n==1then e=z(n[1])else local t=_(n[1])for e=2,#n-1do local l=t t=function(t)return l(t)[n[e]]end end e=function(e)return t(e),n[#n]end end end end local n,r={}if b then add(n,"self")end t"("if not l")"then while true do if l"..."then r=true else add(n,d())end if l")"then break end t","if r then o"unexpected param after '...'"end end end g()for n in all(n)do f[n]=i end if r then f["..."]=i end local l,o,f=x,a,v x,a,v={},u+1,i local i=c()for n in all(x)do n()end x,a,v=l,o,f t"end"k()return function(t)if h then add(t,{})end local l=ee(t)local o=#l local n=function(...)local t,e=pack(...),l if#e~=o then local n={}for t=0,o do n[t]=e[t]end e=n end local l={}for e=1,#n do l[n[e]]=t[e]end if r then l["..."]=pack(unpack(t,#n+1,t.n))end add(e,l)local n=i(e)deli(e)if n then if type(n)=="table"then return nu(n)end return n()end end if s then local e,t=e(t)e[t]=n else return n end end end local function v()local l=r[n]n+=1local n if l==nil then o()end if l=="nil"then return p()end if l=="true"then return p(true)end if l=="false"then return p(false)end if type(l)=="number"then return p(l)end if type(l)=="table"then return p(l.t)end if l=="{"then return nl()end if l=="("then n=e()t")"return function(e)return(n(e))end,true end if l=="-"then n=e(11)return function(e)return-n(e)end end if l=="~"then n=e(11)return function(e)return~n(e)end end if l=="not"then n=e(11)return function(e)return not n(e)end end if l=="#"then n=e(11)return function(e)return#n(e)end end if l=="@"then n=e(11)return function(e)return@n(e)end end if l=="%"then n=e(11)return function(e)return%n(e)end end if l=="$"then n=e(11)return function(e)return$n(e)end end if l=="function"then return j()end if l=="..."then return nt()end if l=="\\"then n=d()return function()return et(n)end,true,function()return el(n)end end if d(l)then return _(l),true,z(l)end o("unexpected token: "..l)end local function z(e,t,l,r)local n if e=="^"and t<=12then n=r(12)return function(e)return l(e)^n(e)end end if e=="*"and t<10then n=r(10)return function(e)return l(e)*n(e)end end if e=="/"and t<10then n=r(10)return function(e)return l(e)/n(e)end end if e=="\\"and t<10then n=r(10)return function(e)return l(e)\n(e)end end if e=="%"and t<10then n=r(10)return function(e)return l(e)%n(e)end end if e=="+"and t<9then n=r(9)return function(e)return l(e)+n(e)end end if e=="-"and t<9then n=r(9)return function(e)return l(e)-n(e)end end if e==".."and t<=8then n=r(8)return function(e)return l(e)..n(e)end end if e=="<<"and t<7then n=r(7)return function(e)return l(e)<<n(e)end end if e==">>"and t<7then n=r(7)return function(e)return l(e)>>n(e)end end if e==">>>"and t<7then n=r(7)return function(e)return l(e)>>>n(e)end end if e=="<<>"and t<7then n=r(7)return function(e)return l(e)<<>n(e)end end if e==">><"and t<7then n=r(7)return function(e)return l(e)>><n(e)end end if e=="&"and t<6then n=r(6)return function(e)return l(e)&n(e)end end if e=="^^"and t<5then n=r(5)return function(e)return l(e)~n(e)end end if e=="|"and t<4then n=r(4)return function(e)return l(e)|n(e)end end if e=="<"and t<3then n=r(3)return function(e)return l(e)<n(e)end end if e==">"and t<3then n=r(3)return function(e)return l(e)>n(e)end end if e=="<="and t<3then n=r(3)return function(e)return l(e)<=n(e)end end if e==">="and t<3then n=r(3)return function(e)return l(e)>=n(e)end end if e=="=="and t<3then n=r(3)return function(e)return l(e)==n(e)end end if(e=="~="or e=="!=")and t<3then n=r(3)return function(e)return l(e)~=n(e)end end if e=="and"and t<2then n=r(2)return function(e)return l(e)and n(e)end end if e=="or"and t<1then n=r(1)return function(e)return l(e)or n(e)end end end local function nt(u,l,a)local i=r[n]n+=1local o,f if a then if i=="."then o=d()return function(n)return l(n)[o]end,true,function(n)return l(n),o end end if i=="["then o=e()t"]"return function(n)return l(n)[o(n)]end,true,function(n)return l(n),o(n)end end if i=="("then return y(l)end if i=="{"or type(i)=="table"then n-=1f=v()return y(l,nil,f)end if i==":"then o=d()if r[n]=="{"or type(r[n])=="table"then f=v()return y(l,o,f)end t"("return y(l,o)end end local e=z(i,u,l,e)if not e then n-=1end return e end e=function(r)local n,e,t,l=v()while true do local r,o,i,f=nt(r or 0,n,e)if not r then break end n,e,t,l=r,o,i,f end return n,t,l end local function v()local e,n=e()if not n then o"cannot assign to value"end return n end local function nt()local n=w(v)t"="local e=w(e)if#n==1and#e==1then return function(t)local n,l=n[1](t)n[l]=e[1](t)end else return function(t)local l,r={},{}for e=1,#n do local n,e=n[e](t)add(l,n)add(r,e)end local e=b(t,e)for n=#n,1,-1do l[n][r[n]]=e[n]end end end end local function nl(t,l)local r=r[n]n+=1local n=sub(r,1,-2)local n=z(n,0,t,function()return e()end)if not n then o"invalid compound assignment"end return function(e)local t,l=l(e)t[l]=n(e)end end local function nr()if l"function"then return j(true,true)else local n,e=w(d),l"="and w(e)or{}g()for e=1,#n do f[n[e]]=i end if#n==1and#e==1then return function(t)add(t,{[n[1]]=e[1](t)})end else return function(t)local l,r={},b(t,e)for e=1,#n do l[n[e]]=r[e]end add(t,l)end end end end local function z(e)local t=q[n-1]h=function()return t~=q[n]end if not e or h()then o(n<=#r and"bad shorthand"or nil)end end local function q()local r,o,e,n=r[n]=="(",e()if l"then"then e,n=c()if l"else"then n=c()t"end"elseif l"elseif"then n=q()else t"end"end else z(r)e=c()if not h()and l"else"then n=c()end h=nil end return function(t)if o(t)then return e(t)elseif n then return n(t)end end end local function v(...)local n=m m=u+1local e=c(...)m=n return e end local function y(n,e)if n==true then return end return n,e end local function no()local r,o,n=r[n]=="(",e()if l"do"then n=v()t"end"else z(r)n=v()h=nil end return function(e)while o(e)do if stat(1)>=1then na()end local n,e=n(e)if n then return y(n,e)end end end end local function z()local l,r=i,v(true)t"until"local o=e()while i>l do k()end return function(n)repeat if stat(1)>=1then na()end local e,t=r(n)if not e then t=o(n)end while#n>l do deli(n)end if e then return y(e,t)end until t end end local function ni()if r[n+1]=="="then local r=d()t"="local o=e()t","local d,e=e(),l","and e()or p(1)t"do"g()f[r]=i local l=v()t"end"k()return function(n)for e=o(n),d(n),e(n)do if stat(1)>=1then na()end add(n,{[r]=e})local e,t=l(n)deli(n)if e then return y(e,t)end end end else local l=w(d)t"in"local e=w(e)t"do"g()for n in all(l)do f[n]=i end local o=v()t"end"k()return function(n)local e=b(n,e)while true do local r,t={},{e[1](e[2],e[3])}if t[1]==nil then break end e[3]=t[1]for n=1,#l do r[l[n]]=t[n]end if stat(1)>=1then na()end add(n,r)local e,t=o(n)deli(n)if e then return y(e,t)end end end end end local function p()if not m or a and m<a then o"break outside of loop"end return function()return true end end local function m()if not a and not ne then o"return outside of function"end if r[n]==";"or nf(r[n],nv)or h and h()then return function()return pack()end else local n,r,t=e()local n={n}while l","do add(n,(e()))end if#n==1and t and a then return function(n)local n,e=t(n)if stat(1)>=1then na()end return function()return n(nu(e))end end else return function(e)return b(e,n)end end end end local function g(e)local n=d()t"::"if s[n]and s[n].e==u then o"label already defined"end s[n]={l=i,e=u,o=e,r=#e}end local function v()local t,e,l,n=d(),s,i add(x,function()n=e[t]if not n then o"label not found"end if a and n.e<a then o"goto outside of function"end local e=e[n.e]or l if n.l>e and n.r<#n.o then o"goto past local"end end)return function()if stat(1)>=1then na()end return 0,n end end local function d(f)local i=r[n]n+=1if i==";"then return end if i=="do"then local n=c()t"end"return n end if i=="if"then return q()end if i=="while"then return no()end if i=="repeat"then return z()end if i=="for"then return ni()end if i=="break"then return p()end if i=="return"then return m(),true end if i=="local"then return nr()end if i=="goto"then return v()end if i=="::"then return g(f)end if i=="function"and r[n]~="("then return j(true)end if i=="?"then local e,t=_"print",w(e)return function(n)e(n)(nu(b(n,t)))end end n-=1local i,e,f,t=n,e()if l","or l"="then n=i return nt()elseif nn(r[n])then return nl(e,f)elseif u<=1and nc then return function(n)local n=pack(e(n))if not(t and n.n==0)then add(nd,n)end nk=n[1]end else if not t then o"statement has no effect"end return function(n)e(n)end end end c=function(e)s=setmetatable({},{__index=s})s[u]=i u+=1local a,f,o=u,e and 32767or i,{}while n<=#r and not nf(r[n],nv)and not(h and h())do local n,e=d(o)if n then add(o,n)end if e then l";"break end end while i>f do k()end u-=1s=getmetatable(s).__index return function(e)local l,r,t,n=1,#o while l<=r do t,n=o[l](e)if t then if type(t)~="number"then break end if n.e~=a then break end l=n.r while#e>n.l do deli(e)end t,n=nil end l+=1end while#e>f do deli(e)end return t,n end end f=nc and{_ENV=0,_env=0,_=0}or{_ENV=0}local e=c()if n<=#r then o"unexpected end"end for n in all(x)do n()end return function(n)local n=nc and{_ENV=n,_env=n,_=nk}or{_ENV=n}local n=e{[0]=n}if n then return nu(n)end end end nx,n3=10,false local t={["\0"]="000",["ᵉ"]="014",["ᶠ"]="015"}for n,e in pairs(o)do if not p(n,"'\n")then t[e]=n end end function er(n)local e=1while e<=#n do local l=b(n,e)local t=t[l]if t then n=sub(n,1,e-1).."\\"..t..sub(n,e+1)e+=#t end e+=1end return'"'..n..'"'end function eo(n)if type(n)~="string"then return false end if ns[n]then return false end if#n==0or y(b(n,1))then return false end for e=1,#n do if not nl(b(n,e))then return false end end return true end function f(e,t)local n=type(e)if n=="nil"then return"nil"elseif n=="boolean"then return e and"true"or"false"elseif n=="number"then return tostr(e,n3)elseif n=="string"then return er(e)elseif n=="table"and not t then local n,t,r="{",0,0for e,l in next,e do if t==nx then n=n..",<...>"break end if t>0then n=n..","end local l=f(l,1)if e==r+1then n=n..l r=e elseif eo(e)then n=n..e.."="..l else n=n.."["..f(e,1).."]="..l end t+=1end return n.."}"else return"<"..tostr(n)..">"end end function ei(n,e)if e==nil then return n end if not n then n=""end local t=min(21,#e)for t=1,t do if#n>0then n..="\n"end local t=e[t]if type(t)=="table"then local e=""for n=1,t.n do if#e>0then e=e..", "end e=e..f(t[n])end n..=e else n..=t end end local l={}for n=t+1,#e do l[n-t]=e[n]end return n,l end poke(24365,1)cls()h="> "a,x,_="",1,0c,z=1,20w,j={""},1ne=false m,u=0,1nh,n0=true,true s={7,4,3,5,6,8,5,12,14,7,11,5}e.print=function(n,...)if pack(...).n~=0or not nh then return print(n,...)end add(nd,tostr(n))end function n_()poke(24368,1)end function nz()return function()if stat(30)then return stat(31)end end end function nm(l,r)local e,n,t=1,0,0if not l then return e,n,t end while e<=#l do local l=b(l,e)local o=l>="█"if n>=(o and 31or 32)then t+=1n=0end if r then r(e,l,n,t)end if l=="\n"then t+=1n=0else n+=o and 2or 1end e+=1end return e,n,t end function nt(t,l)local n,e=0,0local o,r,t=nm(t,function(t,i,r,o)if l==t then n,e=r,o end end)if l>=o then n,e=r,t end if r>0then t+=1end return n,e,t end function nr(l,r,e)local t,n=1,false local r,o,l=nm(l,function(o,f,i,l)if e==l and r==i and not n then t=o n=true end if(e<l or e==l and r<i)and not n then t=o-1n=true end end)if not n then t=e>=l and r or r-1end if o>0then l+=1end return t,l end function n7(n,t,l,e)if type(e)=="function"then nm(n,function(n,r,o,i)print(r,t+o*4,l+i*6,e(n))end)else print(n and"⁶rw"..n,t,l,e)end end function ef(n,r,o)local i,e,f,t=n4(n)local e=1n7(n,r,o,function(r)while e<=#t and t[e]<r do e+=1end local n if e<=#t and f[e]<=r then n=i[e]end local e=s[5]if n==false then e=s[6]elseif n==true then e=s[7]elseif type(n)~="string"or nf(n,{"nil","true","false"})then e=s[8]elseif ns[n]then e=s[9]elseif not nl(b(n,1))then e=s[10]elseif l[n]then e=s[11]end return e end)end function _draw()local r,o,i=peek(24357),peek2(24360),peek2(24362)camera()local function n(n)cursor(0,127)for n=1,n do rectfill(0,u*6,127,(u+1)*6-1,0)if u<21then u+=1else print""end end end local function f(n,e)for n=1,n do if u>e then u-=1end rectfill(0,u*6,127,(u+1)*6-1,0)end end local function d(n,e)for t=0,2do local l=pget(n+t,e+5)pset(n+t,e+5,l==0and s[12]or 0)end end local function l(r)local l=h..a.." "local o,t,e=nt(l,#h+c)if e>x then n(e-x)elseif e<x then f(x-e,e)end x=e _=mid(_,0,max(x-21,0))::n::local n=u-x+_ if n+t<0then _+=1goto n end if n+t>=21then _-=1goto n end local n=n*6rectfill(0,n,127,n+x*6-1,0)if x>21then rectfill(0,126,127,127,0)end ef(l,0,n)print(h,0,n,s[4])if z>=10and r~=false and not v then d(o*4,n+t*6)end end local function f(e)n(1)u-=1print("[enter] ('esc' to abort)",0,u*6,s[3])while true do flip()n_()for n in nz()do if n=="•"then ne=true g=""nd={}return false end if n=="\r"or n=="\n"then m+=e return true end end end end::n::local t,e if nd or g then t,e=nr(g,0,m)if e-m<=20and nd then g,nd=ei(g,nd)t,e=nr(g,0,m)if#nd==0and not v then nd=nil end end end if not v then camera()end if m==0and not v then l(not g)end if g then local r,t=sub(g,t),min(e-m,20)n(t)n7(r,0,(u-t)*6,s[1])if t<e-m then if f(t)then goto n end else local r,o,e=nt(n2,0)n(e)n7(n2,0,(u-e)*6,s[2])if v then m+=t else a,x,_,c,m,g,n2="",0,0,1,0l()end end end if v then n(1)u-=1print(v,0,u*6,s[3])end if q then n(1)u-=1print(q,0,u*6,s[3])q=nil end if nb then nb-=1if nb==0then q,nb=""end end z-=1if z==0then z=20end color(r)camera(o,i)if u<=20then cursor(0,u*6)end end r,d,no=false,false,false ni={}function n9(n,e)i,ed=n,e assert(false,n)end function n5(n,t,l)return ny(n,l)(t or e)end function n6(n,e)return n5("return "..n,e,true)end function eu(n)local e=cocreate(ny)::n::local n,e=coresume(e,n)if n and not e then goto n end if not n then e,i=i,false end return n,e end function ea(n,e)local n,e=nt(n,e)return"line "..e+1 .." col "..n+1end function nj(e,l)nd,ne,i={},false,false r,d,no=false,false,false local t,r,n=cocreate(function()n5(e)end)while true do r,n=coresume(t)if costatus(t)=="dead"then break end if nh and not d then v="running, press 'esc' to abort"_draw()flip()v=nil else if n0 and not d and not no then flip()end if not n0 and holdframe then holdframe()end no=false end for n in nz()do if n=="•"then ne=true else add(ni,n)end end if ne then n="computation aborted"break end end if i==nil then if l then n="unexpected end of code"else n,nd=nil end end if i then n,i=i.."\nat "..ea(e,ed)end n2=n ni={}end na=function()r=true yield()r=false end e.flip=function(...)local n=pack(flip(...))no=true na()return nu(n)end e.coresume=function(n,...)local e=pack(coresume(n,...))while r do yield()e=pack(coresume(n))end i=false return nu(e)end e.stat=function(n,...)if n==30then return#ni>0or stat(n,...)elseif n==31then if#ni>0then return deli(ni,1)else local n=stat(n,...)if n=="•"then ne=true end return n end else return stat(n,...)end end function ec(n)if _set_fps then _set_fps(n._update60 and 60or 30)end if n._init then n._init()end d=true while true do if _update_buttons then _update_buttons()end if holdframe then holdframe()end if n._update60 then n._update60()elseif n._update then n._update()end if n._draw then n._draw()end flip()no=true na()end d=false end function et(n)if nf(n,{"i","interrupt"})then return nh elseif nf(n,{"f","flip"})then return n0 elseif nf(n,{"r","repl"})then return nc elseif nf(n,{"mi","max_items"})then return nx elseif nf(n,{"h","hex"})then return n3 elseif nf(n,{"cl","colors"})then return s elseif nf(n,{"c","code"})then local n={[0]=a}for e=1,#w-1do n[e]=w[#w-e]end return n elseif nf(n,{"cm","compile"})then return function(n)return eu(n)end elseif nf(n,{"x","exec"})then return function(n,e)n5(n,e)end elseif nf(n,{"v","eval"})then return function(n,e)return n6(n,e)end elseif nf(n,{"p","print"})then return function(n,...)e.print(f(n),...)end elseif nf(n,{"ts","tostr"})then return function(n)return f(n)end elseif nf(n,{"rst","reset"})then run()elseif nf(n,{"run"})then ec(e)else assert(false,"unknown \\-command")end end function el(e)local function t(n)return n and n~=0and true or false end local n if nf(e,{"i","interrupt"})then n=function(n)nh=t(n)end elseif nf(e,{"f","flip"})then n=function(n)n0=t(n)end elseif nf(e,{"r","repl"})then n=function(n)nc=t(n)end elseif nf(e,{"mi","max_items"})then n=function(n)nx=tonum(n)or-1end elseif nf(e,{"h","hex"})then n=function(n)n3=t(n)end elseif nf(e,{"cl","colors"})then n=function(n)s=n end else assert(false,"unknown \\-command assign")end local n={__newindex=function(t,l,e)n(e)end}return setmetatable(n,n),0end np=stat(4)n1,nw=0,false poke(24412,10,2)function k(n)if stat(28,n)then if n~=ng then ng,n1=n,0end return n1==0or n1>=10and n1%2==0elseif ng==n then ng=nil end end function _update()local e=false local function t(t)local e,n,l=nt(h..a,#h+c)if n8 then e=n8 end n+=t if not(n>=0and n<l)then return false end c=max(nr(h..a,e,n)-#h,1)n8=e z=20return true end local function o(t)local n,l=nt(h..a,#h+c)n=t>0and 100or 0c=max(nr(h..a,n,l)-#h,1)e=true end local function f(n)w[j]=a j+=n a=w[j]if n<0then c=#a+1else c=max(nr(h..a,32,0)-#h,1)local n=b(a,c)if n~=""and n~="\n"then c-=1end end e=true end local function i()if#a>0then if#w>50then del(w,w[1])end w[#w]=a add(w,"")j=#w e=true end end local function d(n)if c+n>0then a=sub(a,1,c+n-1)..sub(a,c+n+1)c+=n e=true end end local function l(n)a=sub(a,1,c-1)..n..sub(a,c)c+=#n e=true end local r,u,n=stat(28,224)or stat(28,228),stat(28,225)or stat(28,229),-1if k(80)then if c>1then c-=1e=true end elseif k(79)then if c<=#a then c+=1e=true end elseif k(82)then if(r or not t(-1))and j>1then f(-1)end elseif k(81)then if(r or not t(1))and j<#w then f(1)end else local t=stat(31)n=ord(t)if t=="•"then if#a==0then extcmd"pause"else nd,n2={}i()end elseif t=="\r"or t=="\n"then if u then l"\n"else nj(a)if not nd then l"\n"else i()end end elseif r and k(40)then nj(a,true)i()elseif t~=""and n>=32and n<154then if nw and n>=128then t=chr(n-63)end l(t)elseif n==193then l"\n"elseif n==192then o(-1)elseif n==196then o(1)elseif n==203then nw=not nw q,nb="shift now selects "..(nw and"punycase"or"symbols"),40elseif k(74)then if r then c=1e=true else o(-1)end elseif k(77)then if r then c=#a+1e=true else o(1)end elseif k(42)then d(-1)elseif k(76)then d(0)end end local t=stat(4)if t~=np or n==213then l(t)np=t end if n==194or n==215then if a~=""and a~=np then np=a printh(a,"@clip")if n==215then a=""c=1end q="press again to put in clipboard"else q=""end end if stat(120)then local n repeat n=serial(2048,24448,128)l(chr(peek(24448,n)))until n==0end if e then z,n8=20end n1+=1n_()end function nq(n,e)local e,t=coresume(cocreate(e))if not e then printh("error #"..n..": "..t)print("error #"..n.."\npico8 broke something again,\nthis cart may not work.\npress any button to ignore")while btnp()==0do flip()end cls()end end nq(1,function()assert(pack(n6"(function (...) return ... end)(1,2,nil,nil)").n==4)end)nq(2,function()assert(n6"function() local temp, temp2 = {max(1,3)}, -20;return temp[1] + temp2; end"()==-17)end)printh"finished"stop()while true do if holdframe then holdframe()end _update()_draw()flip()end
__meta:title__
keep:------------------------------------
keep: Please see 'Commented Source Code' section in the BBS
